/*! scroblr 2013-09-16 */
var scroblrGlobal=function(){"use strict";function a(){E.noscrobble=E.noscrobble?!1:!0,t("trackNoScrobbleSet")}function b(a){var b,c,d,e,f;d=[],f="";for(c in a)a.hasOwnProperty(c)&&d.push(c);for(d.sort(),b=0,e=d.length;e>b;b+=1)c=d[b],f+=c+a[c];return hex_md5(f+B)}function c(a){return!localStorage["disable_"+a]}function d(a){var b;a.title&&a.artist&&(b={api_key:A,artist:a.artist,track:a.title},G&&G.name&&(b.username=G.name),v("track.getInfo",b,e,f))}function e(a){var b={album:$("track > album title",a).text()||E.album||"",image:$("track > album image[size=large]",a).text()||"",loved:"1"==$("track userloved").text(),url_album:$("track > album url",a).text()||"",url_artist:$("track > artist url",a).text()||"",url_track:$("track > url",a).text()||"",tags:[]};E.duration||(b.duration=parseFloat($("track > duration",a).text())),$("track tag",a).each(function(){b.tags.push({name:$(this).find("name").text(),url:$(this).find("url").text()})}),$.extend(E,b),u(),t("songInfoRetrieved",E),o({image:E.image,message:E.artist+" - "+E.title,title:"Now Playing"})}function f(){"youtube"===E.host?(E.noscrobble=!0,E.editrequired=!0,t("trackEditRequired")):(u(),t("songInfoRetrieved",E),o({message:E.artist+" - "+E.title,title:"Now Playing"}))}function g(a){var b={api_key:A,token:a};a&&v("auth.getSession",b,h)}function h(a){a&&(G={name:$("session name",a).text(),key:$("session key",a).text(),subscriber:"1"==$("session subscriber",a).text()}),localStorage.lf_session=JSON.stringify(G),t("userSessionRetrieved")}function i(){console.log(arguments)}function j(){"undefined"!=typeof chrome?chrome.extension.onMessage.addListener(n):"undefined"!=typeof safari&&safari.application.addEventListener("message",n,!1)}function k(){window.clearTimeout(H),H=window.setTimeout(function(){q(E),r(),E=null,t("keepAliveExpired")},15e3)}function l(){localStorage.removeItem("lf_session"),G=null,t("userLoggedOut",null)}function m(){var a={api_key:A,sk:G.key,artist:E.artist,track:E.title};E.loved===!1?(E.loved=!0,v("track.love",a)):E.loved===!0&&(E.loved=!1,v("track.unlove",a)),t("trackLoved")}function n(b){switch(b.name){case"accessGranted":g(b.message);break;case"authButtonClicked":p();break;case"doNotScrobbleButtonClicked":a();break;case"popupSettingsChanged":t("localSettingsChanged");break;case"logoutLinkClicked":l();break;case"loveTrackButtonClicked":m();break;case"nowPlaying":z(b.message),d(b.message);break;case"trackEdited":y(b.message),w(),t("trackEditSaved");break;case"updateCurrentTrack":y(b.message)}}function o(a){var b;a.image&&a.image.length||(a.image="img/scroblr64.png"),window.webkitNotifications&&c("notifications")&&(b=webkitNotifications.createNotification(a.image,a.title,a.message),b.show(),c("autodismiss")&&window.setTimeout(function(){b.cancel()},5e3))}function p(){var a;"undefined"!=typeof chrome?chrome.tabs.create({url:D+chrome.extension.getURL("access-granted.html")}):"undefined"!=typeof safari&&(a=safari.application.activeBrowserWindow.openTab(),a.url=D+safari.extension.baseURI+"access-granted.html"),t("initUserForm",!0)}function q(a){a&&F.push(a),F.length>25&&F.splice(0,1)}function r(){var a,b,d,e;for(a=0,b=F.length;b>a;a+=1)e=F[a],!e.scrobbled&&G&&c("scrobbling")&&x(e)&&(d={api_key:A,artist:e.artist,sk:G.key,timestamp:Math.round(e.dateTime/1e3),track:e.title},e.album&&(d.album=e.album),s(e,d))}function s(a,b){v("track.scrobble",b,function(){a.scrobbled=!0})}function t(a,b){var c,d;if("undefined"!=typeof chrome)chrome.extension.sendMessage({name:a,message:b});else if("undefined"!=typeof safari)for(c=safari.extension.popovers,d=c.length;d--;)c[d].contentWindow.scroblrView.messageHandler({name:a,message:b})}function u(){var a,b,d,e;a=E.artist&&E.title?!0:!1,d=c("scrobbling"),e=c(E.host),G&&d&&a&&e&&(b={api_key:A,artist:E.artist,sk:G.key,track:E.title},E.duration&&(b.duration=Math.round(E.duration/1e3)),E.album&&(b.album=E.album),v("track.updateNowPlaying",b))}function v(a,c,d,e){var f=["track.love","track.scrobble","track.unlove","track.updateNowPlaying"];c.method=a,c.api_sig=b(c),$.ajax({data:c,error:e||i,success:d,type:f.indexOf(a)>=0?"POST":"GET",url:C})}function w(){E.editrequired&&(E.editrequired=!1,E.noscrobble=!1,u(),o({message:E.artist+" - "+E.title,title:"Now Playing"}))}function x(a){var b,d,e,f,g,h;return b=a.artist&&a.title?!0:!1,d=a.duration>3e4,e=a.elapsed>=24e4,f=a.elapsed>=a.duration/2,g=!a.duration&&a.elapsed>3e4,h=c(a.host),h&&!a.noscrobble&&b&&(d&&(e||f)||g)}function y(a){if(a.id===E.id){k();for(var b in a)a.hasOwnProperty(b)&&("elapsed"===b&&a[b]>E[b]||"elapsed"===b&&!E[b]||"elapsed"!==b)&&(E[b]=a[b])}}function z(a){return"youtube"!==a.host||c("youtube")?(q(E),r(),k(),a.artist||(a.editrequired=!0,a.noscrobble=!0,t("trackEditRequired")),E=$.extend({},a),void 0):!1}var A,B,C,D,E,F,G,H;return A="59c070288bfca89ca9700fde083969bb",B="0193a089b025f8cfafcc922e54b93706",C="http://ws.audioscrobbler.com/2.0/",D="http://www.last.fm/api/auth/?api_key="+A+"&cb=",E=null,F=[],G=JSON.parse(localStorage.lf_session||null),j(),{getCurrentTrack:function(){return E},getHistory:function(){return F},getSession:function(){return G},messageHandler:n}}();
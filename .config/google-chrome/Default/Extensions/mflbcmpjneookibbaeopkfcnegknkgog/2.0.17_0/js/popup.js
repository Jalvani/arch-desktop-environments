/*! scroblr 2014-02-04 */
var scroblrView=function(a,b){"use strict";function c(){o.on("click","#authorizeBtn",function(a){a.preventDefault(),m("authButtonClicked")}),o.on("click",".goto-section",function(b){b.preventDefault(),e(a(this).attr("href").slice(1))}),o.on("click",".goto-link",function(b){b.preventDefault(),h(a(this).attr("href"))}),o.on("click","#doNotScrobbleBtn",function(a){a.preventDefault(),m("doNotScrobbleButtonClicked")}),o.on("click","#loveTrackBtn",function(a){a.preventDefault(),m("loveTrackButtonClicked")}),o.on("click","#logoutLink",function(a){a.preventDefault(),m("logoutLinkClicked")}),o.on("click","#submitTrackEditBtn",function(b){b.preventDefault();var c=p.scroblrGlobal.getCurrentTrack();m("trackEdited",{artist:a(".edit-track input[name=artist]").val(),id:c.id,title:a(".edit-track input[name=title]").val(),album:a(".edit-track input[name=album]").val()})}),a(".settings-options input").on("change",function(a){d.call(this,a)}),"undefined"!=typeof chrome?chrome.extension.onMessage.addListener(g):"undefined"!=typeof safari&&(safari.application.addEventListener("message",g,!1),safari.application.addEventListener("popover",i,!0))}function d(){var b=a(this).attr("id");this.checked?localStorage.removeItem(b):localStorage[b]="true",m("popupSettingsChanged")}function e(a){"edit-track"===a&&k(),o.removeClass().addClass("show-"+a)}function f(){c(),"undefined"!=typeof chrome&&(j(),n())}function g(a){switch(a.name){case"trackLoved":case"trackNoScrobbleSet":case"songInfoRetrieved":window.setTimeout(function(){l()},500);break;case"updateCurrentTrack":a.message.hasOwnProperty("score")&&window.setTimeout(function(){l()},500);break;case"keepAliveExpired":case"trackEditRequired":case"trackEditSaved":case"userLoggedOut":case"userSessionRetrieved":n()}}function h(a){var b;"undefined"!=typeof chrome?chrome.tabs.create({url:a}):"undefined"!=typeof safari&&(b=safari.application.activeBrowserWindow.openTab(),b.url=a)}function i(){j(),n()}function j(){var b,c,d,e;for(e=p.scroblrGlobal.getSession(),d=["disable_scrobbling","disable_notifications","disable_autodismiss","disable_youtube"],b=0,c=d.length;c>b;b+=1)"true"===localStorage[d[b]]&&a("#"+d[b]).prop("checked",!1);e&&a("#userProfile").text(e.name).attr("href","http://last.fm/user/"+e.name)}function k(){var c,d,e;c=a("section.edit-track"),d=a.trim(a("#tmplEditTrack").html()),e=p.scroblrGlobal.getCurrentTrack(),c.html(b.render(d,e))}function l(){var c,d,e;c=a("section.now-playing"),d=a.trim(a("#tmplNowPlaying").html()),e=p.scroblrGlobal.getCurrentTrack(),e&&e.hasOwnProperty("score")&&(e.badscore=e.score<=50?!0:!1),c.html(b.render(d,e))}function m(a,b){p.scroblrGlobal.messageHandler({name:a,message:b})}function n(){var a,b;a=p.scroblrGlobal.getSession(),b=p.scroblrGlobal.getCurrentTrack(),o.removeClass(),a?b&&b.editrequired?(k(),o.addClass("show-edit-track")):(l(),o.addClass("show-now-playing")):o.addClass("show-authenticate")}var o,p;return o=a("body"),"undefined"!=typeof chrome?p=chrome.extension.getBackgroundPage():"undefined"!=typeof safari&&(p=safari.extension.globalPage.contentWindow),f(),{messageHandler:g}}(jQuery,Mustache);
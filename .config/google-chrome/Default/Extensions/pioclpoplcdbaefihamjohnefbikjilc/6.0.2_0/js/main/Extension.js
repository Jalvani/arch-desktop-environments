function Extension(){var L,J;function W(a){a?X||(X=!0,Persistent.get("localStoragePurged")||(Persistent.set("localStoragePurged",!0),delete localStorage.savedAuthInfo,delete localStorage.userCache),e=new BootstrapInfo(options.get("overrideServiceURL")),h=new Auth(options.get("overrideServiceURL"),options.get("secureProto")),!z&&h&&(z=new UsageMetricsManager(options.get("secureProto")+e.get("serviceHost"),h.isAuthenticated,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"))),
Y(),/^5\./.test(versionDetect.getLastVersion())&&/^6\./.test(versionDetect.getSourceVersion())&&h.logoutAll(),firstTime.startUp(),va(),wa(),firstTime.msgHandlerOnInit(),M({startup:!0}),Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32)),xa()):log.warn("Version out of date!")}function Y(){SAFARI||P||(P=!0,chrome.contextMenus.removeAll(function(){ya()}))}function za(a){var c=safari.application.activeBrowserWindow.activeTab,b=a.userInfo;switch(a.command){case m.clipPage:Z(c);
break;case m.clipSelection:$(b,c);break;case m.clipImage:aa(b,c);break;case m.clipPDF:ba(c);break;case m.clipUrl:ca(c)}}function Aa(a){var c=a.userInfo;if(!c||!c.url||c.url.match(/^https?/i)&&!c.url.match(/^https?:\/\/extensions.apple.com/i))a.contextMenu.appendContextMenuItem(m.clipPage,Browser.i18n.getMessage("safariContextClipPage"),m.clipPage),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(m.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),m.clipSelection),
a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(m.clipImage,Browser.i18n.getMessage("safariContextClipImage"),m.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(m.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),m.clipPDF),a.contextMenu.appendContextMenuItem(m.clipUrl,Browser.i18n.getMessage("safariContextClipUrl"),m.clipUrl)}function Z(a){z.recordActivity(h.isAuthenticated);I(a.url)||Browser.sendToTab(a,{name:"scriptsInjectedAlready",
type:"fullPage",source:"contextMenu"})}function $(a,c){z.recordActivity(h.isAuthenticated);I(c.url)||Browser.sendToTab(c,{name:"scriptsInjectedAlready",type:"selection",source:"contextMenu",selectionText:a.selectionText})}function aa(a,c){z.recordActivity(h.isAuthenticated);I(c.url)||Browser.sendToTab(c,{name:"scriptsInjectedAlready",type:"image",imageUrl:a.srcUrl,source:"contextMenu"})}function ba(a){z.recordActivity(h.isAuthenticated);I(a.url)||Browser.sendToTab(a,{name:"scriptsInjectedAlready",
type:"pdf",source:"contextMenu"})}function ca(a){z.recordActivity(h.isAuthenticated);I(a.url)||Browser.sendToTab(a,{name:"scriptsInjectedAlready",type:"url",source:"contextMenu"})}function ya(){P=!1;var a=["http://*/*","https://*/*"];chrome.contextMenus.create({id:"fullPage",title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image"],documentUrlPatterns:a});chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image"],
documentUrlPatterns:a});chrome.contextMenus.create({id:"selection",title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:a});chrome.contextMenus.create({id:"image",title:Browser.i18n.getMessage("contextMenuClipImage"),contexts:["image"],targetUrlPatterns:a});chrome.contextMenus.create({id:"pdf",title:Browser.i18n.getMessage("contextMenuClipPDF"),contexts:["all"],documentUrlPatterns:a});chrome.contextMenus.create({id:"url",title:Browser.i18n.getMessage("contextMenuClipUrl"),
contexts:["all"],documentUrlPatterns:a});chrome.contextMenus.onClicked.addListener(function(a,b){switch(a.menuItemId){case "fullPage":Z(b);break;case "screenshot":z.recordActivity(h.isAuthenticated);I(b.url)||Browser.sendToTab(b,{name:"scriptsInjectedAlready",type:"screenshot",source:"contextMenu"});break;case "selection":$(a,b);break;case "image":aa(a,b);break;case "pdf":ba(b);break;case "url":ca(b)}})}function va(){console.log("initBrowserAction");Browser.setBrowserActionClickHandler(function(a){if("undefined"===
typeof E?0:a.id===E){var c=da("marketingUrl")+"/webclipper/guide";chrome.tabs.remove(a.id);E=null;chrome.tabs.create({url:c,selected:!0},function(a){Ba(a,function(a){Browser.sendToTab(a,{name:"scriptsInjectedAlready"})})})}else firstTime.msgHandlerOnAction(),Browser.sendToTab(a,{name:"scriptsInjectedAlready"})})}function Ba(a,c){L=a.id;J=c}function wa(){function a(a){SAFARI?a.target.browserWindow&&(M(),Browser.sendToTab(a.target,{name:"isExtensionOpen"})):chrome.tabs.get(a.tabId,function(b){M();Browser.sendToTab({id:a.tabId},
{name:"isExtensionOpen"})})}SAFARI?safari.application.addEventListener("activate",a,!0):chrome.tabs.onActivated.addListener(a)}function xa(){h.isAuthenticated(function(a){a&&IDB.initAllStores(a.userId,null,function(a){log.error(a)})})}function Ca(a){Browser.sendToTab(a,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+e.get("serviceHost"),userId:"fake",username:Browser.i18n.getMessage("fleFakeUser"),authTokens:[],premium:!1,favIconUrl:a.favIconUrl,type:G("clipAction"),fullName:Browser.i18n.getMessage("fleFakeUser"),
locale:e.get("name"),numServices:e.getLength(),loggedInUsers:[{name:Browser.i18n.getMessage("fleFakeUser"),id:"fake"}],dontStartPreview:!0});Browser.sendToTab(a,{name:"startTour"})}function Da(a){Browser.sendToTab(a,{name:"insertSerializationScripts"});Browser.sendToTab(a,{name:"setFavIconUrl",favIconUrl:a.favIconUrl});Browser.insertCSS("css/coordinator.css",function(){Browser.insertJS("clearly/js/highlight.js",function(){Browser.insertJS("content/Coordinator.js")})})}function ea(a,c,b,d,f){var k=
[],A=Math.max(3-a.length,2),h=[],k=[];a||(a=[]);b||(b=[]);for(var e=0;e<b.length&&!(h.length>=A&&k.length>=A);e++)if(b[e].inBusinessNotebook=!0,f[b[e].notebookGuid].joined){h.push(b[e]);var g=C(b[e].notebookGuid);g&&(b[e].linkedNotebookGuid=g)}else b[e].notebookName=f[b[e].notebookGuid].name,b[e].contact=b[e].attributes.lastEditedBy||b[e].attributes.author||f[b[e].notebookGuid].contact,k.push(b[e]);e=Math.min(A,h.length);e=Math.max(A-e,1);b=Math.min(e,k.length);A=h.slice(0,A-b);for(e=0;e<b;e++)A.push(k[e]);
k=a.slice(0,3-A.length);for(e=0;e<A.length;e++)k.push(A[e]);for(e=0;e<k.length;e++)k[e].shardId=k[e].inBusinessNotebook?d:c;return k}function Q(){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated"));Browser.setIcon("images/wc6-update")}function R(){firstTime.isUpgraded()?Q():(Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),Browser.setIcon("images/web-clipper"))}function N(){firstTime.isUpgraded()?Q():(Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),Browser.setIcon("images/web-clipper-sign-in"))}
function M(a,c,b){firstTime.isUpgraded()?Q():h.isAuthenticated(function(c){c?a&&a.startup||R():N()})}function F(){var a=Object.keys(g).length;if(SAFARI)for(var c=0;c<safari.extension.toolbarItems.length;c++)safari.extension.toolbarItems[c].badge=a;else chrome.browserAction.setBadgeBackgroundColor({color:[255,255,0,255]}),0==a?chrome.browserAction.setBadgeText({text:""}):chrome.browserAction.setBadgeText({text:a.toString()})}function Ea(a){try{S=new JsonRpc(null,["NoteStore.listLinkedNotebooks"],null,
options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),h.getAuthTokens(function(c){S.initWithAuthToken(c.authenticationToken,a)})}catch(c){log.error("Error running JsonRpcInit: "+JSON.stringify(c))}}function I(a){a=(a+"").toLowerCase();return a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)||!a.match(/^https?:\/\//)?(alert(Browser.i18n.getMessage("illegalUrlClipFailure")),!0):!1}function C(a){return u&&u.getBusinessNotebookByGuid(a)?u.getBusinessNotebookByGuid(a).guid:
null}function fa(a,c,b){log.log("Got restart message...");Browser.removeMessageHandlers();window.location.reload()}function ga(a,c,b){function d(d){if("simSearch"==a.type)Browser.sendToTab(c.tab,{name:"simSearch_isAuthenticated",auth:d});else if("clipResult"==a.type)Browser.sendToTab(c.tab,{name:"clipResult_isAuthenticated",auth:d});else if("options"==a.type)Browser.sendToTab(c.tab,{name:"options_isAuthenticated",auth:d,option:a.option});else if("pdfTooltip"==a.type){var b=Persistent.get(d.userId+
"_pdfTooltipShown");Persistent.set(d.userId+"_pdfTooltipShown",!0);Browser.sendToTab(c.tab,{name:"pdfTooltip_isAuthenticated",auth:d,pdfTooltipShown:b})}else if("tooltip"==a.type){d={name:"tooltip_isAuthenticated",auth:d};if(a.bootstrapInfo)for(b in d.bootstrapInfo={},a.bootstrapInfo)d.bootstrapInfo[b]=e.get(b);Browser.sendToTab(c.tab,d)}}c&&c.tab?h.isAuthenticated(d):h.isAuthenticated(b)}function ha(a,c,b){function d(){h.getCurrentUser()?h.getAuthTokens(function(a){if(a){a={pers:a.authenticationToken,
biz:a.bizAuthenticationToken};for(var d=H(),b=d.length-1;0<=b;b--)d[b]==h.getCurrentUser()?d.splice(b,1):d[b]={id:d[b],name:h.getUserInfo(d[b]).fullName};Browser.sendToTab(c.tab,{name:"logoutCallback",authTokens:a,baseUrl:options.get("secureProto")+e.get("serviceHost"),favIconUrl:c.tab.favIconUrl,fullName:h.getUserInfo().fullName,locale:e.get("name"),loggedInUsers:d,numServices:e.getLength(),premium:h.getUserInfo().premium,type:G("clipAction"),userId:h.getCurrentUser(),username:h.getUserInfo().username,
alwaysTags:options.get("alwaysTagWith")?options.get("alwaysTags"):null,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}else log.error("problem getting tokens while logging out and getting the next user")}):(Browser.sendToTab(c.tab,{name:"logoutCallback"}),Browser.sendToTab(c.tab,{name:"showAuthTools",baseUrl:options.get("secureProto")+e.get("serviceHost"),locale:e.get("name"),numServices:e.getLength()}))}a.fromUrl&&a.fromUrl.match(/^https?:\/\/stage(-corp)?\./)&&!options.get("useStage")||
(a.all?(h.logoutAll(),Browser.sendToTab(c.tab,{name:"logoutCallback"})):a.user?h.logoutUser(a.user,d):h.logout(d,a.authExpired))}function ia(a,c,b){ja(a,c,b);delete g[a.lookupKey];F()}function ja(a,c,b){c=null;a.lookupKey&&(c=g[a.lookupKey]);b&&b(c)}function ka(){function a(a){var b,d;for(b=0;b<a.length;b++)if(a[b].tabs)for(d=0;d<a[b].tabs.length;d++)a[b].tabs[d].url.match(/^chrome.*:\/\//)||(chrome.tabs.sendMessage?chrome.tabs.sendMessage(a[b].tabs[d].id,{name:"preview_clear"}):chrome.tabs.sendRequest(a[b].tabs[d].id,
{name:"preview_clear"}))}SAFARI||chrome.windows.getAll({populate:!0},a)}function Fa(a){D=!1;for(a=0;a<O.length;a++)try{O[a]()}catch(c){log.error("Linked Notebook callback exception: "+c.message+c.stack)}O=[]}function la(a,c,b){Ea(b)}function G(a){return options.get(a)}function da(a){return e?e.get(a):""}function ma(a,c,b){a=a.url;SAFARI?safari.application.activeBrowserWindow.openTab().url=a:chrome.tabs.create({url:a,selected:!0});b&&b()}function na(a,c,b){var d=600,f=600;c="";a.width&&(d=a.width);
a.height&&(f=a.height);a.url&&(c=a.url);c&&(a={url:c,width:d,height:f,type:a.type},SAFARI?safari.application.openBrowserWindow().activeTab.url=c:chrome.windows.create(a));b&&b()}function oa(a,c,b){try{z.recordActivity()}catch(d){log.error("Failed to record user activity: "+d.trace||d.stack||JSON.stringify(d))}b&&b()}function pa(a,c,b){qa.play();setTimeout(function(){a.contextMenu?Browser.captureVisibleTab(a,c,b):Browser.captureVisibleTab(a,c)},300)}function T(a,c,b){c=document.getElementById("temp-textarea");
c||(c=document.createElement("textarea"),c.id="temp-textarea",document.body.appendChild(c));c.value=a.text;c.select();document.execCommand("copy",!1,null)}function ra(a,c,b){g[a.pendingNoteKey]||(g[a.pendingNoteKey]=new PendingNote);F();"skitch"==a.clipType?b=a.content:(b='<br/><div style="position: relative;',a.width&&(b+=" max-width: "+a.width+";"),b+='">'+a.html+"</div><br/>",b=GlobalUtils.removeControlCharacters(b));g[a.pendingNoteKey].content=b;g[a.pendingNoteKey].resources=a.resources;g[a.pendingNoteKey].share=
a.share;g[a.pendingNoteKey].updateGuid=a.updateGuid;g[a.pendingNoteKey].previousToken=a.previousToken;g[a.pendingNoteKey].recommendationText=a.recommendationText;g[a.pendingNoteKey].notDualLink=Boolean(a.hasTextHighlights)||-1<["clearly","email","pdf","skitch"].indexOf(a.clipType);"clearly"==a.clipType&&(a.contentClass="Clearly");Analytics.trackEvent(a.userId,"Clip Type",a.clipType,a.userType);g[a.pendingNoteKey].filingInfo?(g[a.pendingNoteKey].filingInfo.contentClass=a.contentClass,U(a.pendingNoteKey,
c.tab||c.sender.tab,c.portId_)):g[a.pendingNoteKey].tempContentClass=a.contentClass}function sa(a,c,b){g[a.pendingNoteKey]||(g[a.pendingNoteKey]=new PendingNote);F();g[a.pendingNoteKey].relatedNotes=a.noteFilingInfo.relatedNotes;delete a.noteFilingInfo.relatedNotes;g[a.pendingNoteKey].filingInfo=a.noteFilingInfo;g[a.pendingNoteKey].filingInfo.contentClass=g[a.pendingNoteKey].tempContentClass;delete g[a.pendingNoteKey].tempContentClass;g[a.pendingNoteKey].originatingTab=c.tab||c.sender.tab;g[a.pendingNoteKey].portId=
c.portId_;Analytics.trackEvent(a.userId,"Comments",a.noteFilingInfo.comment?"added comments":"did not add comments",a.userType,a.noteFilingInfo.comment?a.noteFilingInfo.comment.length:null);Analytics.trackEvent(a.userId,"Tags",a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?"added tags":"did not add tags",a.userType,a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?a.noteFilingInfo.tagNames.length:null);Ga({pendingNoteKey:a.pendingNoteKey},c);g[a.pendingNoteKey].content&&
U(a.pendingNoteKey,c.tab||c.sender.tab,c.portId_)}function U(a,c,b){var d=options.get("secureProto")+e.get("serviceHost");h.getAuthTokens(function(f){var k;"pers"==g[a].filingInfo.type?k=f.authenticationToken:"linked"==g[a].filingInfo.type?k=g[a].filingInfo.auth:"biz"==g[a].filingInfo.type&&(k=f.bizAuthenticationToken);(new Submitter({submit:k,pers:f.authenticationToken,previous:g[a].previousToken},h.getUserInfo().premium,g[a].updateGuid,d,c,h.getCurrentUser(),function(d){"undefined"!=typeof b&&Browser.closePort(b);
d&&g[a].share&&Ha({auth:k,guid:d.guid,noteSize:d.noteSize,shardId:d.shardId,source:g[a].notDualLink?null:g[a].filingInfo.url},{tab:c});delete g[a];F()})).createNoteWithThrift(g[a].filingInfo,g[a].content,g[a].resources)},!0)}function Ga(a,c,b){if(g[a.pendingNoteKey]){var d={name:"receiveClipResultInfo"};d.title=g[a.pendingNoteKey].filingInfo.title;d.type=g[a.pendingNoteKey].filingInfo.type;d.notebookGuid=g[a.pendingNoteKey].filingInfo.notebookGuid;d.notebookName=g[a.pendingNoteKey].filingInfo.notebookName;
d.linkedNotebookGuid=g[a.pendingNoteKey].filingInfo.linkedNotebookGuid;d.shareKey=g[a.pendingNoteKey].filingInfo.shareKey;d.tagNames=g[a.pendingNoteKey].filingInfo.tagNames;d.client=options.get("client");d.baseUrl=options.get("secureProto")+e.get("serviceHost");d.locale=e.getName();d.userId=h.getCurrentUser();d.url=g[a.pendingNoteKey].filingInfo.url;d.premium=h.getUserInfo().premium;d.updateGuid=g[a.pendingNoteKey].updateGuid;h.getAuthTokens(function(b){b&&("linked"==d.type&&(b.linked=g[a.pendingNoteKey].filingInfo.auth),
d.auth=b,Browser.sendToTab(c.tab||c.sender.tab,d))})}}function Ha(a,c,b){function d(d,b){if(d){var f=options.get("secureProto")+e.get("serviceHost")+"/shard/"+a.shardId+"/sh/"+a.guid+"/"+d;Browser.sendToTab(c.tab,{name:"doneSharing",guid:a.guid,noteSize:a.noteSize,savedAuthInfo:Persistent.get("savedAuthInfo"),shownNearQuotaUpsell:Persistent.get("shownNearQuotaUpsell"),source:a.source,token:a.auth,uploaded:Persistent.get("uploaded"),url:f});a.source?T({text:a.source}):T({text:f})}else y(b,c.tab)}var f;
f=new JsonRpc(null,["NoteStore.shareNote"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.shareNote(d,a.auth,a.guid)})}function H(){return h?h.getLoggedInUserIds():[]}function y(a,c){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken/.test(a.trace)?(ha({authExpired:!0},{tab:c}),c&&Browser.sendToTab(c,{name:"tellUserToLogin"})):log.error(a.trace||a.message||
a.stack||a)}var P=!1,ta=!0,g={};F();var u,V,D=!1,O=[],e,E;J=L=null;var X=!1,S=null,h,z,qa=new Audio;qa.src=Browser.extension.getURL("skitch/sounds/snap.wav");window.addEventListener("offline",function(a){log.log("Went offline.")});window.addEventListener("online",function(a){log.log("Went online.");0<Object.keys(g)&&log.log("processing offline clips");for(var c in g)U(c,g[c].originatingTab,g[c].portId)});SAFARI||chrome.extension.onConnect.addListener(function(a){"popupClosed"===a.name&&a.onDisconnect.addListener(function(){ka()})});
var m={clipPage:"EN_safariContextClipPage",clipSelection:"EN_safariContextClipSelection",clipImage:"EN_safariContextClipImage",clipPDF:"EN_safariContextClipPDF",clipUrl:"EN_safariContextClipUrl"};SAFARI&&(safari.application.addEventListener("contextmenu",Aa,!1),safari.application.addEventListener("command",za,!1));Browser.addMessageHandlers({LOGOUT:ha,main_login:function(a,c,b){a.fromUrl&&a.fromUrl.match(/^https?:\/\/stage(-corp)?\./)&&!options.get("useStage")||h.login(a.username,a.password,function(a){if(!a.error){a.bizAuthenticationToken&&
!Persistent.get(a.userId+"_turnedOffSearchHelper")&&options.set("useSearchHelper",!0);for(var b=H(),k=b.length-1;0<=k;k--)b[k]==a.userId?b.splice(k,1):b[k]={id:b[k],name:h.getUserInfo(b[k]).fullName};a.baseUrl=options.get("secureProto")+e.get("serviceHost");a.favIconUrl=c.tab.favIconUrl;a.locale=e.get("name");a.loggedInUsers=b;a.numServices=e.getLength();a.type=G("clipAction");a.alwaysTags=options.get("alwaysTagWith")?options.get("alwaysTags"):null;a.keyboardShortcutsEnabled=options.get("enableKeyboardShortcuts")}Browser.sendToTab(c.tab,
{name:"loginResponse",response:a})})},main_isAuthenticated:ga,submitTwoStepCode:function(a,c,b){h.completeTwoFactorAuthentication(a.auth,a.code,function(a){if(!a.error){for(var b=H(),k=b.length-1;0<=k;k--)b[k]==a.userId?b.splice(k,1):b[k]={id:b[k],name:h.getUserInfo(b[k]).fullName};a.baseUrl=options.get("secureProto")+e.get("serviceHost");a.favIconUrl=c.tab.favIconUrl;a.locale=e.get("name");a.loggedInUsers=b;a.numServices=e.getLength();a.type=G("clipAction");a.alwaysTags=options.get("alwaysTagWith")?
options.get("alwaysTags"):null;a.keyboardShortcutsEnabled=options.get("enableKeyboardShortcuts")}Browser.sendToTab(c.tab,{name:"twoStepResponse",response:a})})},getRegistrationLinks:function(a,c,b){b="clipper_chr";SAFARI?b="clipper_saf":OPERA&&(b="clipper_op");var d=new FormData;d.append("code",b);var f=new XMLHttpRequest;f.open("POST",a.baseUrl+"/CreateUserJSON.action?",!0);f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var b=JSON.parse(f.response);a.refresh?Browser.sendToTab(c.tab,
{name:"refreshCaptcha",captcha:b.captcha,submit:b.submit}):Browser.sendToTab(c.tab,{name:"loadReg",baseUrl:a.baseUrl,captcha:b.captcha,locale:a.locale,submit:b.submit})}};f.send(d)},setCurrentUser:function(a,c,b){h&&(h.setCurrentUser(a.user),h.getAuthTokens(function(b){if(b){var f={pers:b.authenticationToken,biz:b.bizAuthenticationToken},k=H();for(b=k.length-1;0<=b;b--)k[b]==a.user?k.splice(b,1):k[b]={id:k[b],name:h.getUserInfo(k[b]).fullName};IDB.initAllStores(a.user,function(){Browser.sendToTab(c.tab,
{name:"showCoordinator",authTokens:f,baseUrl:options.get("secureProto")+e.get("serviceHost"),fullName:h.getUserInfo(a.user).fullName,locale:e.get("name"),loggedInUsers:k,numServices:e.getLength(),premium:h.getUserInfo(a.user).premium,userId:a.user,username:h.getUserInfo(a.user).username})},function(a){log.error(a)})}else log.warn("could not get tokens while switching users")}))},switchService:function(a,c,b){1<e.getLength()&&(a=e.getIndex(),e.setIndex((a+1)%2),Browser.sendToTab(c.tab,{name:"showAuthTools",
baseUrl:options.get("secureProto")+e.get("serviceHost"),locale:e.get("name"),numServices:e.getLength()}))},logoutWebClient:function(a,c,b){var d=new XMLHttpRequest,f=options.get("secureProto")+e.get("serviceHost");d.open("GET",f+"/Logout.action",!0);d.onreadystatechange=function(){4==d.readyState&&"v1"==a.reason&&na({height:600,width:800,url:f+"/Login.action?username="+encodeURIComponent(a.username)+"&targetUrl="+encodeURIComponent("/ChangePassword.action?v1=true")})};d.send()},main_getTextResource:function(a,
c,b){function d(a){f.readyState==f.DONE&&(e.responseText=200==f.status?f.responseText:null,Browser.sendToTab(c.tab,e))}var f,e={name:"content_textResource",href:null};a&&a.href&&(e.href=a.href,f=new XMLHttpRequest,f.open("GET",a.href),f.onreadystatechange=d,f.send());b&&b()},injectScript:function(a,c,b){Browser.insertJS(a.script,function(){Browser.sendToTab(c.tab,{name:"injectedScript",script:a.script})})},main_performNoteSearch:function(a,c,b){function d(a,b){a.name="sameSiteNotes";Browser.sendToTab(c.tab,
a)}function f(a){r=a;(s.bizAuthenticationToken&&n||!s.bizAuthenticationToken)&&d(g())}function k(a){n=a;r&&d(g())}function g(){for(var a=0;a<r.notes.list.length;a++)r.notes.list[a].shardId=p.shardId;if(s.bizAuthenticationToken){for(var a=r.notes.list.slice(0),c=0;c<n.notes.list.length;c++)n.notes.list[c].inBusinessNotebook=!0,n.notes.list[c].shardId=v.shardId,C(n.notes.list[c].notebookGuid)&&(n.notes.list[c].linkedNotebookGuid=C(n.notes.list[c].notebookGuid)),a.push(n.notes.list[c]);a.sort(function(a,
c){return c.updated-a.updated});a=a.slice(0,l);r.notesSize=Math.min(r.notesSize+n.notesSize,l);r.totalNotes+=n.totalNotes;r.notes.list=a}return r}function K(){p.client.NoteStoreExtra.findNotesWithSnippet(f,s.authenticationToken,B,0,l,t);s.bizAuthenticationToken&&v.client.NoteStoreExtra.findNotesWithSnippet(k,s.bizAuthenticationToken,B,0,l,t)}var t=a.resultSpec,B=a.noteFilter,s,p,v,r,n,l=10;a.maxNotes&&(l=a.maxNotes);h.isAuthenticated(function(a){if((s=a)&&s.authenticationToken){var c=options.get("secureProto")+
e.get("serviceHost");p=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],c,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));p.initWithAuthToken(s.authenticationToken,function(){s.bizAuthenticationToken?(v=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],c,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),v.initWithAuthToken(s.bizAuthenticationToken,K)):K()})}else d(null)});b&&b()},simSearch_getNotesRelatedToSearchQuery:function(a,
c,b){Browser.sendToTab(c.tab,{name:"getInfo",sendToTab:!0})},simSearch_receivePageInfo:function(a,c,b){function d(){var b;if("Google"!==a.info.searchEngine&&q.bizAuthenticationToken){var d=Math.max(3-n.length,2),f=[];b=[];for(var e=0;e<l.length&&!(f.length>=d&&b.length>=d);e++)l[e].inBusinessNotebook=!0,l[e].shardId=r.shardId,w[l[e].notebookGuid].joined?(f.push(l[e]),C(l[e].notebookGuid)&&(l[e].linkedNotebookGuid=C(l[e].notebookGuid))):(l[e].notebookName=w[l[e].notebookGuid].name,l[e].contact=l[e].attributes.lastEditedBy||
l[e].attributes.author||w[l[e].notebookGuid].contact,b.push(l[e]));for(var e=Math.min(d,f.length),e=Math.max(d-e,1),k=Math.min(e,b.length),d=f.slice(0,d-k),e=0;e<k;e++)d.push(b[e]);b=n.slice(0,3-d.length);for(e=0;e<d.length;e++)b.push(d[e]);0<m.length&&(b[Math.max(0,b.length-1)]=m[0]);b=0<b.length?b:null;Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b,type:"all",tokens:{pers:q.authenticationToken,biz:q.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(q.userId+
"_noSimsearchResultsShown")})}else{if(q.bizAuthenticationToken){d=[];b=[];for(f=0;f<l.length&&!(3<=d.length&&3<=b.length);)l[f].inBusinessNotebook=!0,l[f].shardId=r.shardId,w[l[f].notebookGuid].joined?(d.push(l[f]),C(l[f].notebookGuid)&&(l[f].linkedNotebookGuid=C(l[f].notebookGuid))):(l[f].notebookName=w[l[f].notebookGuid].name,l[f].contact=l[f].attributes.lastEditedBy||l[f].attributes.author||w[l[f].notebookGuid].contact,b.push(l[f])),f++;f=Math.max(3-d.length,1);f=Math.min(f,b.length);l=d.slice(0,
3-f);for(d=0;d<f;d++)l.push(b[d]);0<m.length&&(l[Math.max(0,l.length-1)]=m[0]);b=[];0<n.length&&(b[0]=n);0<l.length&&(b[1]=l)}else b=0<n.length?[n]:[];Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b[0],type:"account",isBizUser:Boolean(q.bizAuthenticationToken),tokens:{pers:q.authenticationToken,biz:q.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(q.userId+"_noSimsearchResultsShown")});q.bizAuthenticationToken&&Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",
relatedNotes:b[1],type:"library",tokens:{pers:q.authenticationToken,biz:q.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(q.userId+"_noSimsearchResultsShown")})}}function f(a,b){a?(n=a.relatedNotes?a.relatedNotes.list:[],(q.bizAuthenticationToken&&l&&u&&!D&&t()&&m||!q.bizAuthenticationToken)&&d()):y(b,c.tab)}function k(a,b){if(a){if(a.relatedNotes){for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];w[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,
contact:e.contactName}}l=a.relatedNotes.list}else l=[];n&&u&&!D&&t()&&m&&d()}else y(b,c.tab)}function g(a,b){m=[];a?a.experts&&a.experts.list&&0<a.experts.list.length&&m.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):y(b,c.tab);n&&u&&!D&&t()&&l&&d()}function K(){D=!1;n&&l&&d()}function t(){for(var a=0;a<l.length;a++)if(w[l[a].notebookGuid].joined&&null==u.getBusinessNotebookByGuid(l[a].notebookGuid))return a=
{token:q.authenticationToken},q.businessId&&(a.businessId=q.businessId),u=new LinkedNotebooks(a,v,K,c.tab),!1;return!0}function B(){return{url:a.info.url,text:a.info.recommendationText,query:a.info.query,relatedNotesResultSpec:{includeTitle:!0,includeUpdated:!0,includeAttributes:!0,includeLargestResourceSize:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeUpdateSequenceNum:!0}}}function s(){JsonQueue.handleExpensiveOpRequest({shardId:v.shardId,userId:q.userId,type:"pers"},v.client.NoteStoreExtra.getFilingRecommendations,
f,q.authenticationToken,B())}function p(){JsonQueue.handleExpensiveOpRequest({shardId:r.shardId,userId:q.userId,type:"biz"},r.client.NoteStoreExtra.getFilingRecommendations,k,q.bizAuthenticationToken,B());if(!u){D=!0;var b={token:q.authenticationToken};q.businessId&&(b.businessId=q.businessId);u=new LinkedNotebooks(b,v,K,c.tab)}r.client.NoteStore.findRelated(g,q.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}var v,r,n,l,m,w={},q,x;h.isAuthenticated(function(a){q=a;x=options.get("secureProto")+
e.get("serviceHost");v=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.listLinkedNotebooks"],x,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));v.initWithAuthToken(q.authenticationToken,s);q.bizAuthenticationToken&&(r=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.findRelated"],x,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),r.initWithAuthToken(q.bizAuthenticationToken,p))})},togglePDFContextMenuOption:function(a,
c,b){SAFARI||a.show==ta||((ta=a.show)?Y():chrome.contextMenus.remove("pdf"))},getNotebooks:function(a,c,b){function d(){l.client.NoteStore.listNotebooks(f,a.authTokens.pers);l.client.NoteStore.listLinkedNotebooks(k,a.authTokens.pers)}function f(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f={},e=0;e<a.list.length;e++)a.list[e].stack?(f[a.list[e].stack]||(f[a.list[e].stack]=[]),f[a.list[e].stack].push({defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name,stack:a.list[e].stack})):
d.push({class:"notebook",defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name});for(var k in f)d.push({class:"stack",name:k,notebooks:f[k]});IDB.setGroup(w,"notebooks",d,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receivePersNotebooks",notebooks:d,recentNotebooks:Persistent.get("recentNotebooks")})}}else w==h.getCurrentUser()&&y(b,c.tab)}function k(b,d){if(b){var f;a.authTokens.biz&&(f=h.getUserInfo(w).businessId);r=b.list.length;for(var k=0;k<b.list.length;k++){var l=
b.list[k];f&&f==l.businessId?B[l.shareKey]={shareName:l.shareName,stack:l.stack}:s[l.shareKey]={shareName:l.shareName,stack:l.stack};v[l.shardId]||(v[l.shardId]=new JsonRpc(l.shardId,["NoteStore.authenticateToSharedNotebook","NoteStore.getSharedNotebookByAuth"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),v[l.shardId].initWithAuthToken(a.authTokens.pers));var q=v[l.shardId];(function(){var b=l;if(b.shareKey)q.client.NoteStore.authenticateToSharedNotebook(function(a,
c){a&&(a.linkedNotebookGuid=b.guid,a.shardId=b.shardId);g(a,c)},b.shareKey,a.authTokens.pers);else if(n++,r==n){for(var d in x)p.push({class:"stack",name:d,notebooks:x[d]});IDB.setGroup(w,"sharedNotebooks",p,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:p})}})()}}else w==h.getCurrentUser()&&y(d,c.tab)}function g(a,b){if(a){var d=v[a.shardId];ua[a.authenticationToken]=setTimeout(function(){n++;if(r==n){for(var a in x)p.push({class:"stack",name:a,notebooks:x[a]});
IDB.setGroup(w,"sharedNotebooks",p,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:p})}},1E4);d.client.NoteStore.getSharedNotebookByAuth(function(c,b){c&&(c.authenticationToken=a.authenticationToken,c.username=a.user?a.user.username:a.publicUserInfo.username,c.linkedNotebookGuid=a.linkedNotebookGuid);clearTimeout(ua[a.authenticationToken]);m(c,b)},a.authenticationToken)}else if(w==h.getCurrentUser()&&(n++,y(b,c.tab),r==n)){for(d in x)p.push({class:"stack",
name:d,notebooks:x[d]});IDB.setGroup(w,"sharedNotebooks",p,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:p})}}function m(b,d){n++;b?b.notebookModifiable&&(B[b.shareKey]?(n--,u.client.NoteStore.getNotebook(function(a,c){a&&(a.name=B[b.shareKey].shareName,a.linkedNotebookGuid=b.linkedNotebookGuid,a.stack=B[b.shareKey].stack);t(a,c)},a.authTokens.biz,b.notebookGuid)):s[b.shareKey]?s[b.shareKey].stack?(x[s[b.shareKey].stack]||(x[s[b.shareKey].stack]=[]),x[s[b.shareKey].stack].push({auth:b.authenticationToken,
guid:b.notebookGuid,name:s[b.shareKey].shareName,linkedUsername:b.username,linkedNotebookGuid:b.linkedNotebookGuid,shareKey:b.shareKey,type:"linked"})):p.push({class:"notebook",auth:b.authenticationToken,guid:b.notebookGuid,name:s[b.shareKey].shareName,linkedUsername:b.username,linkedNotebookGuid:b.linkedNotebookGuid,shareKey:b.shareKey,stack:s[b.shareKey].stack,type:"linked"}):log.warn("received unknown shared notebook"+JSON.stringify(b))):w==h.getCurrentUser()&&y(d,c.tab);if(r==n){for(var f in x)p.push({class:"stack",
name:f,notebooks:x[f]});IDB.setGroup(w,"sharedNotebooks",p,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:p})}}function t(a,b){n++;if(a){var d={guid:a.guid,name:a.name,linkedNotebookGuid:a.linkedNotebookGuid,type:"biz"};a.contact.username!=q&&(d.bizUsername=a.contact.name);a.stack?(x[a.stack]||(x[a.stack]=[]),x[a.stack].push(d)):(d.class="notebook",p.push(d))}else w==h.getCurrentUser()&&y(b,c.tab);if(r==n){for(var f in x)p.push({class:"stack",name:f,notebooks:x[f]});
IDB.setGroup(w,"sharedNotebooks",p,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:p})}}var B={},s={},p=[],v={},r=0,n=0,l,u,w=a.userId,q=a.username,x={},ua={};b=new Worker("js/main/cache_loader.js");b.addEventListener("message",function(a){"persNotebooks"==a.data.name?Browser.sendToTab(c.tab,{name:"receivePersNotebooks",notebooks:JSON.parse(String.fromCharCode.apply(null,new Uint16Array(a.data.notebooks))),recentNotebooks:Persistent.get("recentNotebooks")}):
"sharedNotebooks"==a.data.name?Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:JSON.parse(String.fromCharCode.apply(null,new Uint16Array(a.data.notebooks)))}):"log"==a.data.name&&log.error(a.data.msg)});b.postMessage({userId:w,type:"notebooks"});(function(){l=new JsonRpc(null,["NoteStore.listNotebooks","NoteStore.listLinkedNotebooks"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));l.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?
(u=new JsonRpc(null,["NoteStore.getNotebook"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),u.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getTags:function(a,c,b){function d(){g.client.NoteStore.listTags(k,a.authTokens.pers);a.authTokens.biz&&m.client.NoteStore.listTags(f,a.authTokens.biz)}function f(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);IDB.setGroup(t,"bizTags",d,function(a){log.error(a)});
Browser.sendToTab(c.tab,{name:"receiveBizTags",tags:d})}}else t==h.getCurrentUser()&&y(b,c.tab)}function k(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);IDB.setGroup(t,"tags",d,function(a){log.error(a)});Browser.sendToTab(c.tab,{name:"receivePersTags",tags:d})}}else t==h.getCurrentUser()&&y(b,c.tab)}var g,m,t=a.userId;b=new Worker("js/main/cache_loader.js");b.addEventListener("message",function(a){"persTags"==a.data.name?Browser.sendToTab(c.tab,
{name:"receivePersTags",tags:JSON.parse(String.fromCharCode.apply(null,new Uint16Array(a.data.tags)))}):"bizTags"==a.data.name?Browser.sendToTab(c.tab,{name:"receiveBizTags",tags:JSON.parse(String.fromCharCode.apply(null,new Uint16Array(a.data.tags)))}):"log"==a.data.name&&log.error(a.data.msg)});b.postMessage({userId:t,type:"tags"});(function(){g=new JsonRpc(null,["NoteStore.listTags"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));g.initWithAuthToken(a.authTokens.pers,
function(){a.authTokens.biz?(m=new JsonRpc(null,["NoteStore.listTags"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),m.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getSmartFilingInfo:function(a,c,b){function d(){var b;s&&(b=JSON.parse(JSON.stringify(s)));var c;p&&(c=JSON.parse(JSON.stringify(p)));var d={},f;f=ea(b&&b.relatedNotes?b.relatedNotes.list:[],v.shardId,c&&c.relatedNotes?c.relatedNotes.list:[],r?r.shardId:null,u);0<f.length&&(d.relatedNotes=
{list:f});"smartFiling"==options.get("notebookSelection")&&(b&&b.notebook&&(d.notebook=b.notebook),a.authTokens.biz&&options.get("bizSmartFilingEnabled")&&c&&c.notebook&&!c.notebook.restrictions.noCreateNotes&&(d.notebook=c.notebook,d.notebook.biz=!0));options.get("smartFilingTags")&&(b&&b.tags&&(d.tags=b.tags),a.authTokens.biz&&c&&c.tags&&d.notebook&&d.notebook.biz&&(d.tags=c.tags));return d}function f(){v=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),
e.get("serviceHost"),options.get("overrideServiceURL"));v.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?(r=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),r.initWithAuthToken(a.authTokens.biz,function(){k()})):k()})}function k(){var b={query:a.query,relatedNotesResultSpec:z,text:a.recText,url:c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:v.shardId,userId:t,type:"pers"},v.client.NoteStoreExtra.getFilingRecommendations,
m,a.authTokens.pers,b);a.authTokens.biz&&(b.relatedNotesResultSpec.maxResults=10,JsonQueue.handleExpensiveOpRequest({shardId:r.shardId,userId:t,type:"biz"},r.client.NoteStoreExtra.getFilingRecommendations,g,a.authTokens.biz,b))}function g(a,b){l=!0;if(a){if(a.relatedNotes){u={};for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];u[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}p=a}else t==h.getCurrentUser()&&y(b,c.tab);n&&
Browser.sendToTab(c.tab,{name:"receiveSmartFilingInfo",filingInfo:d()})}function m(b,f){n=!0;b?s=b:t==h.getCurrentUser()&&y(f,c.tab);(a.authTokens.biz&&l||!a.authTokens.biz)&&Browser.sendToTab(c.tab,{name:"receiveSmartFilingInfo",filingInfo:d()})}var t=a.userId,u,s,p,v,r,n,l,z={includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0};a.recText?f():log.warn("no recommendation text")},getKeyboardShortcuts:function(a,c,b){b={};for(var d=0;d<a.shortcuts.length;d++)b[a.shortcuts[d]]=
options.get(a.shortcuts[d]);Browser.sendToTab(c.tab,{name:"receiveKeyboardShortcuts",keys:b})},main_getNoteByKeyAndClear:ia,main_getNoteByKeyAndKeep:ja,main_getNoteByKeyAndRetry:function(a,c,b){var d;a&&a.lookupKey&&(d=g[a.lookupKey]);d&&c.tab&&Browser.sendToTab(c.tab,{name:"content_startClip",attrs:d});F();a:if(a=a.lookupKey){var f;if("string"===typeof a){f=g[a];if(!f){log.warn("Tried to process note by key: "+a+" but couldn't find it. Abandoning.");break a}a=f}else try{f=UUID.generateGuid(),g[f]=
a,a.lookupKey=f}catch(e){log.error("Couldn't save new pendingNote, deleting and skipping.");delete g[f];break a}u&&!D&&a.bizNotebook&&(a.bizNotebook.linkedGuid=C(a.bizNotebook.guid));F();new JclipSubmitter(h,a)}else log.error("processClip received null input, not doing anything.");b&&b(null)},main_JsonRpcInit:la,main_setOption:function(a,c,b){for(var d in a.options)options.set(d,a.options[d]);b&&b()},main_getConfig:function(a,c,b){var d={name:"config"};a.returnName&&(d.name=a.returnName);if(a.options){d.options=
{};for(var f in a.options)d.options[f]=options.get(f)}if(a.bootstrapInfo)for(f in d.bootstrapInfo={},a.bootstrapInfo)e&&(d.bootstrapInfo[f]=e.get(f));Browser.sendToTab(c.tab,d);b&&b(d)},main_openTab:ma,main_openWindow:na,main_restart:fa,main_recordActivity:oa,main_incrementUser:function(a,c,b){if(h&&(a=h.getLoggedInUserIds(),!(1>=a.length))){b=h.getCurrentUser();for(var d=0,f=0;f<a.length;f++)if(a[f]==b){d=f+1;break}d==a.length&&(d=0);h.setCurrentUser(a[d]);Browser.sendToTab(c.tab,{name:"content_userChanged",
username:h.getUserInfo(a[d]).username})}},main_getL10n:function(a,c,b){Browser.sendToTab(c.tab,{name:"l10nData",data:Browser.i18n._getL10nData()});b&&b()},bounce:function(a,c,b){c.tab&&(a.message.tab=c.tab,Browser.sendToTab(c.tab,a.message))},insertCSS:function(a,c,b){Browser.insertCSS(a.filename)},getPersistentFlag:function(a,c,b){Browser.sendToTab(c.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)});a.set&&Persistent.set(a.key,a.setValue)},clipArticle:function(a,c,b){clipArticleFromTab(c.tab,
a.attrs);ka();b&&b()},captureScreenshot:pa,prepareScreenshot:function(a,c,b){Browser.sendToTab(c.tab,{name:"hideScrollbar"});Browser.sendToTab(c.tab,{name:"hideCoordinator",for:"screenshot",tool:a.tool,showSubtools:a.showSubtools})},copyText:T,getOption:function(a,c,b){a.name="receiveOption";"defaultClipAction"==a.option?(a.key="clipAction","lastUsed"==options.get("defaultClipAction")?(b=Persistent.get("lastUsedAction"),a.value=b?b:"ARTICLE"):a.value=options.get("clipAction")):(a.key=a.option,a.value=
options.get(a.key));delete a.option;Browser.sendToTab(c.tab,a)},receiveNoteContent:ra,receiveNoteFilingInfo:sa,getRelatedNotes:function(a,c,b){function d(){Browser.sendToTab(c.tab,{name:"relatedNotes",relatedNotes:ea(m?m:[],s.shardId,t?t:[],p?p.shardId:null,u)})}function f(){var b={relatedNotesResultSpec:{includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:g[a.pendingNoteKey].recommendationText,url:c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:s.shardId,
userId:a.userId,type:"pers"},s.client.NoteStoreExtra.getFilingRecommendations,h,a.tokens.authenticationToken,b);a.tokens.bizAuthenticationToken&&JsonQueue.handleExpensiveOpRequest({shardId:p.shardId,userId:a.userId,type:"biz"},p.client.NoteStoreExtra.getFilingRecommendations,k,a.tokens.bizAuthenticationToken,b)}function k(a,b){if(a)if(a.relatedNotes&&a.relatedNotes.list){t=a.relatedNotes.list;for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];u[e.guid]={joined:e.hasSharedNotebook,
name:e.notebookDisplayName,contact:e.contactName}}}else t=[];else t=[],y(b,c.tab);m&&d()}function h(b,f){b?m=b.relatedNotes&&b.relatedNotes.list?b.relatedNotes.list:[]:(m=[],y(f,c.tab));(!a.tokens.bizAuthenticationToken||a.tokens.bizAuthenticationToken&&t)&&d()}var m,t,u={},s,p;g[a.pendingNoteKey]&&(g[a.pendingNoteKey].relatedNotes?Browser.sendToTab(c.tab,{name:"relatedNotes",relatedNotes:g[a.pendingNoteKey].relatedNotes}):(s=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),
e.get("serviceHost"),options.get("overrideServiceURL")),s.initWithAuthToken(a.tokens.authenticationToken,function(){a.tokens.bizAuthenticationToken?(p=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL")),p.initWithAuthToken(a.tokens.bizAuthenticationToken,f)):f()})))},scriptsInjectedAlready:function(a,c,b){console.log("TAB "+c.tab.id+" URL="+c.tab.url);c.tab.id===E?Da(c.tab):a.injected?h.isAuthenticated(function(b){if(b){var f=
{pers:b.authenticationToken};b.bizAuthenticationToken&&(f.biz=b.bizAuthenticationToken);for(var k=H(),g=k.length-1;0<=g;g--)k[g]==b.userId?k.splice(g,1):k[g]={id:k[g],name:h.getUserInfo(k[g]).fullName};"contextMenu"==a.source?Browser.sendToTab(c.tab,{name:"startSubmission",contextMenu:!0,type:a.type,selectionText:a.selectionText,imageUrl:a.imageUrl}):Browser.sendToTab(c.tab,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+e.get("serviceHost"),userId:b.userId,username:b.username,authTokens:f,
premium:b.premium,favIconUrl:c.tab.favIconUrl,type:G("clipAction"),fullName:b.fullName,locale:e.get("name"),numServices:e.getLength(),loggedInUsers:k,alwaysTags:options.get("alwaysTagWith")?options.get("alwaysTags"):null,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}else N(),Browser.sendToTab(c.tab,{name:"showAuthTools",baseUrl:options.get("secureProto")+e.get("serviceHost"),locale:e.get("name"),numServices:e.getLength()})}):(Browser.sendToTab(c.tab,{name:"insertSerializationScripts"}),
Browser.sendToTab(c.tab,{name:"setFavIconUrl",favIconUrl:c.tab.favIconUrl}),h.isAuthenticated(function(b){if("contextMenu"==a.source&&b){var f="free";b.bizAuthenticationToken?f="business":b.premium&&(f="premium");if("fullPage"==a.type)Browser.sendToTab(c.tab,{name:"clipFullPage",userId:b.userId,userType:f});else if("selection"==a.type)Browser.sendToTab(c.tab,{name:"clipSelection",selectionText:a.selectionText,userId:b.userId,userType:f});else if("image"==a.type)Browser.sendToTab(c.tab,{name:"clipImage",
imageUrl:a.imageUrl,userId:b.userId,userType:f});else if("pdf"==a.type)Browser.sendToTab(c.tab,{name:"clipPdf",userId:b.userId,userType:f});else if("url"==a.type)Browser.sendToTab(c.tab,{name:"clipUrl",userId:b.userId,userType:f});else if("screenshot"==a.type){var e=Browser.openPort({tabId:c.tab.id});Browser.sendToTab(c.tab,{name:"hideBodyScrollbar",portId:e,userId:b.userId,userType:f})}}else Browser.insertCSS("css/coordinator.css",function(){Browser.insertCSS("fonts/GothamSSm-Medium.otf",function(){Browser.insertCSS("fonts/GothamSSm-Bold.otf",
function(){Browser.insertJS("clearly/js/highlight.js",function(){Browser.insertJS("content/Coordinator.js")})})})})}))},uiReady:function(a,c,b){c.tab.id===E?Ca(c.tab):h.isAuthenticated(function(a){if(a){var b={pers:a.authenticationToken};a.bizAuthenticationToken&&(b.biz=a.bizAuthenticationToken);for(var k=H(),g=k.length-1;0<=g;g--)k[g]==a.userId?k.splice(g,1):k[g]={id:k[g],name:h.getUserInfo(k[g]).fullName};Browser.sendToTab(c.tab,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+e.get("serviceHost"),
userId:a.userId,username:a.username,authTokens:b,premium:a.premium,favIconUrl:c.tab.favIconUrl,type:G("clipAction"),fullName:a.fullName,locale:e.get("name"),numServices:e.getLength(),loggedInUsers:k,alwaysTags:options.get("alwaysTagWith")?options.get("alwaysTags"):null,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}else N(),Browser.sendToTab(c.tab,{name:"showAuthTools",baseUrl:options.get("secureProto")+e.get("serviceHost"),locale:e.get("name"),numServices:e.getLength()})})},trackEvent:function(a,
c,b){Analytics.trackEvent(a.userId,a.category,a.action,a.label,a.value)},emailNote:function(a,c,b){function d(b,d){Browser.sendToTab(c.tab,{name:"emailResult",numEmailed:a.recipients.length,error:d});d&&y(d,c.tab)}var f;f=new JsonRpc(null,["NoteStore.emailNote","NoteStoreExtra.emailNotesSharedWorkaround"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){a.sharedAuth?f.client.NoteStoreExtra.emailNotesSharedWorkaround(d,a.sharedAuth,
a.persAuth,{javaClass:"java.util.ArrayList",list:a.recipients},{javaClass:"java.util.ArrayList",list:[a.noteGuid]},a.message):f.client.NoteStore.emailNote(d,a.auth,{guid:a.noteGuid,toAddresses:{javaClass:"java.util.ArrayList",list:a.recipients},message:a.message})})},findContacts:function(a,c,b){function d(a,b){a&&a.list?Browser.sendToTab(c.tab,{name:"receiveContacts",contacts:a.list}):y(b,c.tab)}var f;f=new JsonRpc(null,["NoteStore.findContacts"],null,options.get("secureProto"),e.get("serviceHost"),
options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.findContacts(d,a.auth,{maxEntries:5,prefix:a.prefix})})},showOpenState:function(){Browser.setIcon("images/close-ext")},showLoggedInState:R,showLoggedInOrOutState:M,setReminder:function(a,c,b){function d(a,b){b&&y(b,c.tab)}var f;f=new JsonRpc(null,["NoteStore.updateNote"],null,options.get("secureProto"),e.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){var b={source:"web.clip",
sourceURL:a.sourceURL,reminderOrder:a.reminderOrder};a.reminderTime&&(b.reminderTime=a.reminderTime);f.client.NoteStore.updateNote(d,a.auth,{guid:a.noteGuid,title:a.title,attributes:b})})},clipResultShown:function(a,c,b){c.portId_=a.portId;sa({noteFilingInfo:{title:c.tab.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:c.tab.url},pendingNoteKey:a.pendingNoteKey,userId:a.userId,userType:a.userType},c)},bodyScrollbarHidden:function(a,c,b){var d=UUID.generateGuid();pa({contextMenu:!0},
c,function(b){Browser.sendToTab(c.tab,{name:"showClipResult",pendingNoteKey:d,portId:a.portId,userId:a.userId,userType:a.userType},a.portId);b=atob(b.split(",")[1]);for(var e=new Uint8Array(b.length),g=0;g<b.length;g++)e[g]=b.charCodeAt(g);c.portId_=a.portId;ra({clipType:"skitch",content:'<img src="resource:0"></img>',contentClass:"evernote.skitch",pendingNoteKey:d,resources:[{bytes:e,mime:"image/png"}],userId:a.userId,userType:a.userType},c)})},getPersistentValue:function(a,c,b){Browser.sendToTab(c.tab,
{name:"receivePersistentValue",key:a.key,value:Persistent.get(a.key)})},setPersistentValue:function(a,c,b){Persistent.set(a.key,a.value)},downloadThumbnail:function(a,c,b){b=new XMLHttpRequest;b.guid=a.guid;b.open("POST",a.url,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){if(200==this.status&&4==this.readyState){for(var a="",b=new Uint8Array(this.response),e=0;e<b.length;e++)a+=String.fromCharCode(b[e]);Browser.sendToTab(c.tab,{name:"receiveThumbnail",guid:this.guid,datauri:"data:"+
this.getResponseHeader("Content-type")+";base64,"+btoa(a)})}};a.biz?a.size?b.send("auth="+a.tokens.biz+"&size="+a.size):b.send("auth="+a.tokens.biz):b.send("auth="+a.tokens.pers+"&size="+a.size)},cropImage:function(a,c,b){var d=new Image;d.onload=function(){var b=document.createElement("canvas");b.width=Math.min(150,a.width);b.height=Math.min(150,a.height);b.getContext("2d").drawImage(d,Math.max(0,(a.width-150)/2),Math.max(0,(a.height-150)/2),b.width,b.height,0,0,b.width,b.height);Browser.sendToTab(c.tab,
{name:"receiveCroppedImage",datauri:b.toDataURL(),url:a.url})};d.src=a.url},tourLoaded:function(a,c,b){E=c.tab.id;Browser.sendToTab(c.tab,{name:"scriptsInjectedAlready"});b&&b()},isTouring:function(a,c,b){Browser.sendToTab(c.tab,{name:"isTouring",data:"undefined"===typeof E?!1:c.tab.id===E});b&&b()},tabLoaded:function(a,c,b){a=c.tab;console.log("Autorun");a.id===L&&J&&(c=J,L=J=null,console.log("Executed"),c(a))}});this.setOption=function(a,c){options.set(a,c)};this.getOption=G;this.getBootstrapInfo=
da;this.start=function(){(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(W)};this.startUp=W;this.bootstrap=function(a){(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(function(){try{e=new BootstrapInfo(options.get("overrideServiceURL")),a&&a()}catch(c){log.error(c)}})};this.getLoggedInUserIds=
H;this.getUserInfo=function(a){return h?h.getUserInfo(a):{}};this.showLoggedInState=R;this.showLoggedOutState=N;this.msgHandlerGetNoteByKeyAndClear=ia;this.setBadge=F;this.msgHandlerIsAuthenticated=ga;this.msgHandlerOpenTab=ma;this.msgHandlerJsonRpcInit=la;this.msgHandlerGetWritableLinkedNotebooks=function(a,c,b){var d="";h&&(d=h.getUserInfo().username);d||log.warn("Couldn't look up current user.");O.push(function(){var a=u.getWritableLinkedNotebooks();b&&b({books:a,username:d})});D||(D=!0,h.getAuthTokens(function(a){var b=
h.getUserInfo(),c={token:a.authenticationToken};a.bizAuthenticationToken&&(c.businessId=b.businessId);u=new LinkedNotebooks(c,S,Fa)}))};this.msgHandlerRequestBizNotebooks=function(a,c,b){a.rpc.client.NoteStore.listNotebooks(function(c,e){if(c){for(var g={list:[]},h=0;h<c.list.length;h++)u.getBusinessNotebookByGuid(c.list[h].guid)&&g.list.push(c.list[h]);V=new BusinessNotebooks(a.auth,g.list);b(g)}else log.error("problem retrieving business notebooks: "+JSON.stringify(e))},a.auth)};this.getBizNotebookByGuid=
function(a){return V?V.getBizNotebookByGuid(a):null};this.getLinkedNotebookGuidOfBizNotebook=C;this.msgHandlerRestart=fa;this.msgHandlerRecordActivity=oa;this.handlePopupExpensiveOpRequest=function(){JsonQueue.handleExpensiveOpRequest.apply(this,arguments)};Object.preventExtensions(this)}Object.preventExtensions(Extension);var extension=new Extension;null!=Persistent.get("BootstrapInfoIndex")&&void 0!=Persistent.get("BootstrapInfoIndex")&&Persistent.get("BootstrapInfo")?extension.startUp(!0):extension.start();
